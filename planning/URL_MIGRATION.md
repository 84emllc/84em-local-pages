# URL Structure Migration Plan for 84EM Local Pages

## Overview

This document outlines the plan to simplify the URL structure for all local pages generated by the 84em-local-pages plugin.

## Current vs Desired URL Structure

### Current URLs
- **Index:** `/wordpress-development-services-usa/`
- **State:** `/wordpress-development-services-usa/wordpress-development-services-alabama/`
- **City:** `/wordpress-development-services-usa/wordpress-development-services-alabama/montgomery/`

### Desired URLs
- **Index:** `/wordpress-development-services-usa/` (unchanged)
- **State:** `/wordpress-development-services-usa/alabama/`
- **City:** `/wordpress-development-services-usa/alabama/montgomery/`

## Benefits

1. **Cleaner URLs:** Removes redundant "wordpress-development-services-" prefix from state slugs
2. **Better UX:** Shorter, more readable URLs
3. **Consistent Hierarchy:** All local pages clearly under `/wordpress-development-services-usa/` parent
4. **Easier to Remember:** State and city names directly in URL path

## Implementation Steps

### 1. Create Redirects Layer (New Architecture Component)

**New Class:** `src/Redirects/LegacyUrlRedirector.php`

**Namespace:** `EightyFourEM\LocalPages\Redirects`

**Responsibilities:**
- Detect legacy URL patterns
- Map old URLs to new URLs
- Issue 301 permanent redirects
- Hook into WordPress `template_redirect`

**Constructor Dependencies:**
- `StatesProvider` (for state/city data validation)

**Methods:**
- `initialize()` - Register WordPress hooks
- `handleRedirect()` - Main redirect logic
- `isLegacyStateUrl()` - Detect old state URL pattern
- `isLegacyCityUrl()` - Detect old city URL pattern
- `convertToNewUrl()` - Transform old URL to new format

**Registration in Container:**
- Update `src/Plugin.php` to register `LegacyUrlRedirector` as singleton
- Initialize in `initializeServices()` method

**Example Implementation:**
```php
<?php
namespace EightyFourEM\LocalPages\Redirects;

use EightyFourEM\LocalPages\Data\StatesProvider;

class LegacyUrlRedirector {
    private StatesProvider $statesProvider;

    public function __construct( StatesProvider $statesProvider ) {
        $this->statesProvider = $statesProvider;
    }

    public function initialize(): void {
        add_action( 'template_redirect', [ $this, 'handleRedirect' ] );
    }

    public function handleRedirect(): void {
        $request_uri = $_SERVER['REQUEST_URI'] ?? '';

        // Check for legacy state URL pattern
        if ( $this->isLegacyStateUrl( $request_uri ) ) {
            $new_url = $this->convertStateUrl( $request_uri );
            wp_redirect( $new_url, 301 );
            exit;
        }

        // Check for legacy city URL pattern
        if ( $this->isLegacyCityUrl( $request_uri ) ) {
            $new_url = $this->convertCityUrl( $request_uri );
            wp_redirect( $new_url, 301 );
            exit;
        }
    }

    private function isLegacyStateUrl( string $url ): bool {
        return (bool) preg_match(
            '#^/wordpress-development-services-usa/wordpress-development-services-([^/]+)/?$#',
            $url
        );
    }

    private function isLegacyCityUrl( string $url ): bool {
        return (bool) preg_match(
            '#^/wordpress-development-services-usa/wordpress-development-services-([^/]+)/([^/]+)/?$#',
            $url
        );
    }

    private function convertStateUrl( string $url ): string {
        preg_match(
            '#^/wordpress-development-services-usa/wordpress-development-services-([^/]+)/?$#',
            $url,
            $matches
        );
        $state_slug = $matches[1] ?? '';
        return home_url( "/wordpress-development-services-usa/{$state_slug}/" );
    }

    private function convertCityUrl( string $url ): string {
        preg_match(
            '#^/wordpress-development-services-usa/wordpress-development-services-([^/]+)/([^/]+)/?$#',
            $url,
            $matches
        );
        $state_slug = $matches[1] ?? '';
        $city_slug  = $matches[2] ?? '';
        return home_url( "/wordpress-development-services-usa/{$state_slug}/{$city_slug}/" );
    }
}
```

### 2. Update State Slug Generation

**File:** `src/Content/StateContentGenerator.php`

#### Change 1: Line 419-431 - `setupStateUrl()` method
```php
// OLD:
$desired_slug = "wordpress-development-services-{$slug}";

// NEW:
$desired_slug = $slug;  // Just the state slug
```

#### Change 2: Line 406-409 - `generateStateUrl()` method
```php
// OLD:
return home_url( "/wordpress-development-services-{$slug}/" );

// NEW:
return home_url( "/wordpress-development-services-usa/{$slug}/" );
```

#### Change 3: Add parent relationship to index page
In the `generateState()` method, before creating the post:
```php
// Fetch index page ID
$index_page = get_page_by_path( 'wordpress-development-services-usa' );
$parent_id  = $index_page ? $index_page->ID : 0;

// Add to $post_data array:
'post_parent' => $parent_id,
```

### 3. Update ContentProcessor URL Generation

**File:** `src/Utils/ContentProcessor.php`

#### Change 1: Line 434-437 - `generateStateUrl()` method
```php
// OLD:
return home_url( "/wordpress-development-services-{$slug}/" );

// NEW:
return home_url( "/wordpress-development-services-usa/{$slug}/" );
```

#### Change 2: Line 447-451 - `generateCityUrl()` method
```php
// OLD:
return home_url( "/wordpress-development-services-{$state_slug}/{$city_slug}/" );

// NEW:
return home_url( "/wordpress-development-services-usa/{$state_slug}/{$city_slug}/" );
```

### 4. Update Schema URL Generation

**File:** `src/Schema/SchemaGenerator.php`

#### Change 1: Line 81 - State schema URL fallback
```php
// OLD:
$url = $post_id ? get_permalink( $post_id ) : site_url( '/wordpress-development-' . sanitize_title( $state ) . '/' );

// NEW:
$url = $post_id ? get_permalink( $post_id ) : site_url( '/wordpress-development-services-usa/' . sanitize_title( $state ) . '/' );
```

#### Change 2: Line 159 - City schema URL fallback
```php
// OLD:
$url = $post_id ? get_permalink( $post_id ) : site_url( "/wordpress-development-{$state_slug}/{$city_slug}/" );

// NEW:
$url = $post_id ? get_permalink( $post_id ) : site_url( "/wordpress-development-services-usa/{$state_slug}/{$city_slug}/" );
```

#### Change 3: Line 185 - Breadcrumb schema
```php
// OLD:
'item' => site_url( "/wordpress-development-{$state_slug}/" ),

// NEW:
'item' => site_url( "/wordpress-development-services-usa/{$state_slug}/" ),
```

### 5. Update Link Stripping Pattern

**File:** `src/Cli/Commands/GenerateCommand.php`

#### Change 1: Line 1282 - Update regex to handle both old and new formats
```php
// OLD:
$pattern = '/<a\s+href=["\']\/?wordpress-development-services-[^"\']+["\']>([^<]+)<\/a>/i';

// NEW - Support both legacy and new URL patterns during migration:
$pattern = '/<a\s+href=["\']\/?(wordpress-development-services-usa\/)?wordpress-development-services-[^"\']+["\']>([^<]+)<\/a>/i';
```

### 6. Add WP-CLI Migration Command

**File:** `src/Cli/Commands/GenerateCommand.php`

#### New Method: `handleUrlMigration()`

```php
/**
 * Migrate all local pages from old URL structure to new URL structure.
 *
 * @return void
 */
private function handleUrlMigration(): void {
    WP_CLI::log( 'Starting URL migration for all local pages...' );

    // Get index page ID
    $index_page = get_page_by_path( 'wordpress-development-services-usa' );
    if ( ! $index_page ) {
        WP_CLI::error( 'Index page "wordpress-development-services-usa" not found. Please generate it first.' );
        return;
    }
    $index_page_id = $index_page->ID;

    // Get all state pages (currently have long slugs)
    $state_pages = get_posts( [
        'post_type'      => 'page',
        'post_status'    => 'publish',
        'posts_per_page' => -1,
        'meta_query'     => [
            [
                'key'     => '_local_page_type',
                'value'   => 'state',
                'compare' => '=',
            ],
        ],
    ] );

    $total_states = count( $state_pages );
    WP_CLI::log( "Found {$total_states} state pages to migrate." );

    $progress = \WP_CLI\Utils\make_progress_bar( 'Migrating state pages', $total_states );

    foreach ( $state_pages as $post ) {
        $state = get_post_meta( $post->ID, '_local_page_state', true );
        if ( ! $state ) {
            $progress->tick();
            continue;
        }

        // New slug is just the state name (sanitized)
        $new_slug = sanitize_title( $state );

        // Update post slug and parent
        wp_update_post( [
            'ID'          => $post->ID,
            'post_name'   => $new_slug,
            'post_parent' => $index_page_id,
        ] );

        $progress->tick();
    }

    $progress->finish();

    // Get all city pages (these will automatically update due to parent changes)
    $city_pages = get_posts( [
        'post_type'      => 'page',
        'post_status'    => 'publish',
        'posts_per_page' => -1,
        'meta_query'     => [
            [
                'key'     => '_local_page_type',
                'value'   => 'city',
                'compare' => '=',
            ],
        ],
    ] );

    $total_cities = count( $city_pages );
    WP_CLI::log( "Found {$total_cities} city pages (URLs will auto-update based on parent)." );

    // Flush rewrite rules to regenerate permalinks
    flush_rewrite_rules();

    WP_CLI::success( "Migrated {$total_states} state pages. City page URLs updated automatically." );
    WP_CLI::log( '' );
    WP_CLI::log( 'Next steps:' );
    WP_CLI::log( '1. wp 84em local-pages --update-keyword-links' );
    WP_CLI::log( '2. wp 84em local-pages --generate-sitemap' );
    WP_CLI::log( '3. wp rewrite flush' );
}
```

#### Register Command Flag

Add to command registration in `CommandHandler.php`:
```php
'migrate-urls' => [
    'optional'    => true,
    'type'        => 'flag',
    'description' => 'Migrate all local pages from old URL structure to new URL structure',
],
```

### 7. Update Plugin.php to Register Redirector

**File:** `src/Plugin.php`

#### Add to `registerServices()` method:
```php
// Register redirector
$this->container->singleton( Redirects\LegacyUrlRedirector::class, function( $container ) {
    return new Redirects\LegacyUrlRedirector(
        $container->get( Data\StatesProvider::class )
    );
} );
```

#### Add to `initializeServices()` method:
```php
// Initialize redirector
$this->container->get( Redirects\LegacyUrlRedirector::class )->initialize();
```

## Migration Workflow

### Step-by-Step Execution

1. **Backup Database**
   ```bash
   wp db export backup-before-url-migration.sql
   ```

2. **Deploy Code Changes**
   - Deploy all code changes from steps 1-7 above
   - LegacyUrlRedirector will handle old URLs immediately

3. **Run URL Migration Command**
   ```bash
   wp 84em local-pages --migrate-urls
   ```
   This updates all page slugs and parent relationships.

4. **Update All Internal Links**
   ```bash
   wp 84em local-pages --update-keyword-links
   ```
   This reprocesses all content to update city links and keyword links.

5. **Regenerate Sitemap**
   ```bash
   wp 84em local-pages --generate-sitemap
   ```
   This creates sitemap with new URLs.

6. **Flush Rewrite Rules**
   ```bash
   wp rewrite flush
   ```
   Ensures WordPress rebuilds permalink structure.

7. **Test Sample URLs**
   - Test new state URL: `/wordpress-development-services-usa/california/`
   - Test new city URL: `/wordpress-development-services-usa/california/los-angeles/`
   - Test old state URL redirects: `/wordpress-development-services-usa/wordpress-development-services-california/`
   - Test old city URL redirects: `/wordpress-development-services-usa/wordpress-development-services-california/los-angeles/`

## Testing Plan

### Local/Staging Testing

1. **URL Format Verification**
   - [ ] State pages use new format: `/wordpress-development-services-usa/{state}/`
   - [ ] City pages use new format: `/wordpress-development-services-usa/{state}/{city}/`
   - [ ] Index page unchanged: `/wordpress-development-services-usa/`

2. **Redirect Testing**
   - [ ] Old state URL → New state URL (301)
   - [ ] Old city URL → New city URL (301)
   - [ ] Test with curl: `curl -I https://84em.local/wordpress-development-services-usa/wordpress-development-services-california/`

3. **Link Integrity**
   - [ ] All internal state→city links work
   - [ ] All service keyword links work
   - [ ] Sitemap contains only new URLs
   - [ ] No broken links in content

4. **Schema Validation**
   - [ ] LD-JSON URLs use new format
   - [ ] Test with Google Rich Results Test
   - [ ] Breadcrumb schema correct

### Production Deployment

1. **Pre-Deployment**
   - [ ] Test all changes on staging/local
   - [ ] Backup production database
   - [ ] Document rollback procedure

2. **Deployment**
   - [ ] Deploy code changes
   - [ ] Run migration command
   - [ ] Update links and sitemap
   - [ ] Flush rewrite rules

3. **Post-Deployment**
   - [ ] Verify sample URLs work
   - [ ] Test redirects with curl
   - [ ] Check sitemap
   - [ ] Monitor for 404 errors

## Rollback Plan

### If Issues Arise

1. **Database Rollback**
   ```bash
   wp db import backup-before-url-migration.sql
   ```

2. **Code Rollback**
   - Revert to previous Git commit
   - Redeploy old code

3. **Redirect Safety**
   - LegacyUrlRedirector can remain active indefinitely
   - No harm if old URLs still exist
   - Can run migration again after fixes

### Long-Term Considerations

- Keep LegacyUrlRedirector active permanently (handles cached/external old links)
- Monitor server logs for 404s on old URL patterns
- Consider updating external backlinks if any exist

## Architecture Benefits

✅ **Separation of Concerns:** Redirects isolated in dedicated `Redirects` namespace
✅ **Dependency Injection:** Uses Container pattern like rest of plugin
✅ **Testable:** LegacyUrlRedirector can be unit tested independently
✅ **Maintainable:** Clear namespace organization following existing structure
✅ **Follows Plugin Patterns:** Matches existing `Api/`, `Cli/`, `Content/` layer organization
✅ **Non-Breaking:** Old URLs continue to work via 301 redirects

## Documentation Updates Required

After migration, update the following files:

- [ ] `CLAUDE.md` - Update URL examples and patterns
- [ ] `README.md` - Update URL structure documentation
- [ ] `CHANGELOG.md` - Document URL migration in version entry

## Notes

- Migration is **one-way** (old URLs redirect to new, but not vice versa)
- LegacyUrlRedirector should remain active permanently
- All 350 pages (50 states + 300 cities) will be updated
- Index page (`wordpress-development-services-usa`) remains unchanged
- Parent-child relationships ensure hierarchical URL structure

---

**Document Version:** 1.0
**Created:** 2025-11-02
**Status:** Planning
